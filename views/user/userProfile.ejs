<%- include('../layouts/user/header1.ejs') -%>

<style>
    input {
  width: 100%;
  padding: 12px 20px;
  box-sizing: border-box;
}
</style>

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Majestic</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a>
                        <span>User Profile</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Breadcrumb Section End -->

    <div class="container container1">
        <div class="main-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex flex-column align-items-center text-center">
                            <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Admin"
                                class="rounded-circle" width="150">
                            <div class="mt-3">
                                <h4><%= locals.user.name %></h4>
                                <p class="text-muted font-size-sm"><%= locals.user.email %></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="user-headerrr">
                        <div class="menu-itemmm"><h>Profile</h3></div><hr>
                      </div>
                
                      <!-- Sidebar Menu -->
                  
                      <div class="menu-itemmm" ><a href="/address">Manage Address</a></div><hr>
                      <div class="menu-itemmm" ><a href="/orders">Orders</a></div><hr>
                      <!-- <div class="menu-itemmm"><a href="/wishlist">Wishlist</a></div><hr> -->
                      <div class="menu-itemmm"><a href="/wallet">Wallet</a></div><hr>
                      <div class="menu-itemmm"><a href="/myCoupon">MyCoupons</a></div><hr>
                      <!-- <div class="menu-itemmm" ><a href="#">Report a Bug</a></div><hr> -->
                      <div class="menu-itemmm" ><a  href="/signout" >Logout</a></div><hr>
                      
                </div>
            </div>
                <div class="col-md-8">
                    <div class="card mb-3">
                        <div class="card-body">
                            <form method="post" id="profile-form" onsubmit="return validate()">
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mt-3">Full Name</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">
                                        <input type="text" class="form-control editable" value="<%=locals.user.name%>" name="updatedName" id="profile-name" readonly>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mt-3">Email</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">
                                        <input type="email" class="form-control" value="<%=locals.user.email%>" name="email" id="profile-email" readonly>
                                    </div>
                                </div>
                                <hr>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-3">
                                        <h6 class="mt-3">Mobile</h6>
                                    </div>
                                    <div class="col-sm-9 text-secondary">
                                        <input type="text" class="form-control editable" value="<%=locals.user.mobile%>" name="updatedMobile" id="profile-mobile" readonly>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-12">
                                       <button type="button" class="btn btn-dark" onclick="toggleEdit('<%= locals.user.email %>')">edit</button>
                                       <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#changePassword">Change Password</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Reset Password Modal -->
    <!-- ====================== -->
    <div class="modal fade" id="changePassword" tabindex="-1" aria-labelledby="addVariantModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetPasswordModalLabel">Change Password</h5>
                    <button type="button" class="close" data-dismiss="modal" data-target="#changePassword" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    
                </div>
                <form action="">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="oldPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="oldPassword" placeholder="Enter your current password" name="oldPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="oldPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" placeholder="Enter your new password" name="newPassword" required>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="Re-enter new password" name="confirmPassword" required>
                        </div>
                    </div>
                    <div class="modal-footer align-items-center">
                        <button type="submit" class="btn btn-dark" onclick="return resetpass('<%=user.email%>')">Change</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Reset Password Modal -->
    <!-- ====================== -->

    <%- include('../layouts/user/footer1.ejs') -%>

    <script>

        function toggleEdit(email)
        {
            const mail = { mail : email };
            console.log("hii",mail);

            const input = document.querySelectorAll('.editable');
            input.forEach(function(input)
            {
                input.removeAttribute('readonly');
            });

            const editButton = document.querySelector('#profile-form button');
            editButton.textContent = 'Submit';
            editButton.setAttribute('onclick', `submitForm('${mail.mail}')`);
        }


        function submitForm(userEmail)
        {
            const updatedName = document.getElementById('profile-name').value;
            const updatedMobile = document.getElementById('profile-mobile').value;

            //perform validation
            if(! updatedName || !updatedMobile)
            {
                Swal.fire(
                    {
                        icon : 'error',
                        title : 'Validation Error',
                        text : 'Name and Mobile cannot be empty',
                    }
                );
                return
            }
            else if( !/^\w+$/.test(updatedName) )
            {
                Swal.fire(
                    {
                        icon : 'error',
                        title : 'Validation Error',
                        text : 'Name cannot be empty'
                    }
                );
                return
            }
            else if( updatedMobile.trim().length !== 10 || !/^\d+$/.test(updatedMobile) )
            {
                Swal.fire(
                    {
                        icon : 'error',
                        title : 'Validation error',
                        text : 'Mobile number must be 10 digits',
                    }
                );
                return
            }

            const data = 
            {
                userEmail  : userEmail,
                updatedName : updatedName,
                updatedMobile : updatedMobile,
            };
console.log(data);
            Swal.fire(
                {
                    title : 'Are you sure ?',
                    icon : 'warning',
                    showCancelButton : true,
                    confirmButtonColor : '#3085d6',
                    cancelButtonColor : '#d33',
                    confirmButtonText : 'Yes',
                }
            )
            .then((res) =>
            {
                if(res.isConfirmed)
                {
                    $.ajax(
                        {
                            method : 'POST',
                            url : '/edit-profile',
                            data : JSON.stringify(data),
                            contentType : 'application/json',
                            success : function (response) 
                            {
                                if(response.edited === true)
                                {
                                    Swal.fire(
                                        {
                                            icon : 'success',
                                            text : 'Successfully updated'
                                        }
                                    )
                                    .then(() =>
                                    {
                                        location.reload();
                                    })
                                }
                                else
                                {
                                    Swal.fire(
                                        {
                                            icon : 'error',
                                            text : 'Failed to edit profile. User name already taken.',
                                        }
                                    )
                                    .then(() =>
                                    {
                                        location.reload();
                                    })
                                }
                            },
                            error : function(error)
                            {
                                console.log(error);
                            }
                        }
                    );
                }
            });
        }

    </script>

<script>
    
    function resetpass(Useremail) {
    const email = Useremail;
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
  
    // validation
    if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{6,}$/.test(oldPassword)) {
      document.getElementById('oldPassword').classList.add('error-border');
        document.getElementById('oldPassword').classList.remove('error-border');
        Swal.fire({
          icon: 'error',
          text: 'Password must be at least 6 characters long and contain at least one uppercase letter, one lowercase letter, and one number',
        });
        return
      }
      
  
      if (newPassword !== confirmPassword) {
          Swal.fire({
            icon: 'error',
            text: 'Passwords must match',
            timer: 1500
          });
          return;
      } else {
            
  
            const data = {
              userEmail: email,
              oldPass: oldPassword,
              newPassword: newPassword,
              confirmPass: confirmPassword
            };
  
            console.log("> >", data);
  
            $.ajax({
              method: 'POST',
              url: '/change-password',
              data: JSON.stringify(data),
              contentType: 'application/json',
              success: function (response) {
                if (response.reseted) {
                  Swal.fire({
                    icon: 'success',
                    text: 'Successfully updated',
  
                  }).then(() => {
                   window.location.reload()
                    
                  });
                  document.getElementById('oldPassword').value = '';
                  document.getElementById('newPassword').value = '';
                  document.getElementById('confirmPassword').value = '';
                  $('#resetPasswordModal').modal('hide');
                } 
                else if(response.reset == true) {
                  Swal.fire({
                    icon: 'error',
                    text: 'new password cannot be same as the old password',
                    timer: 1500
                  })
                    
                  
                  document.getElementById('newPassword').value = '';
                  document.getElementById('confirmPassword').value = '';
                }
                else{
                    Swal.fire({
                    icon: 'error',
                    text: 'You have to enter the correct old password',
                    timer: 1500
                  })

                  document.getElementById('oldPassword').value = '';
                }
              },
              error: function (error) {
                console.log(error);
              }
            });
          }
        }
  
      
  
    </script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Include jQuery before using it -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>