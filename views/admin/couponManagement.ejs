<%- include('../layouts/admin/header.ejs') -%>

    <div class="screen-overlay"></div>
    <aside class="navbar-aside" id="offcanvas_aside">
        <div class="aside-top">
            <a href=/admin/home class="brand-wrap">
                <img src="/imgs/theme/Majestic.png" class="logo" alt="Majestic Dashboard" />
            </a>
            <div>
                <button class="btn btn-icon btn-aside-minimize"><i
                        class="text-muted material-icons md-menu_open"></i></button>
            </div>
        </div>
        <nav>
            <ul class="menu-aside">
                <li class="menu-item">
                    <a class="menu-link" href="/admin/home">
                        <i class="icon material-icons md-home"></i>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/userlist">
                        <i class="icon material-icons md-shopping_bag"></i>
                        <span class="text">Customers</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/product">
                        <i class="icon material-icons md-shopping_cart"></i>
                        <span class="text">Products</span>
                    </a>

                </li>
                <li class="menu-item active">
                    <a class="menu-link" href="/admin/category">
                        <i class="icon material-icons md-add_box"></i>
                        <span class="text">Categories</span>
                    </a>

                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/orders">
                        <i class="icon material-icons md-store"></i>
                        <span class="text">Orders</span>
                    </a>

                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/coupon">
                        <i class="icon material-icons md-monetization_on"></i>
                        <span class="text">Coupon</span>
                    </a>

                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/banner">
                        <i class="icon material-icons md-person"></i>
                        <span class="text">Banner</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/sales-report">
                        <i class="icon material-icons md-monetization_on"></i>
                        <span class="text">Sales</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>
    <main class="main-wrap">
        <%- include('../partials/logout-dark.ejs') -%>
            <section class="content-main">
                <div class="content-header">
                    <div>
                        <h2 class="content-title card-title">Coupon List</h2>
                        <p>All Coupon</p>
                    </div>
                    <div>
                        <button href="#" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addCoupon">
                            <i class="material-icons md-plus"></i> Create coupon
                        </button>
                    </div>
                </div>
                <div class="card mb-4">
                    <header class="card-header">
                        <div class="row gx-3">
                            <div class="col-lg-4 col-md-6 me-auto">
                                <input type="text" placeholder="Search..." class="form-control" />
                            </div>
                        </div>
                    </header>
                    <!-- card-header end// -->
                    <div class="card mb-4">
                        <!-- card-header end// -->
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="couponReload">
                                    <thead>
                                        <tr class="table-dark">
                                            <th>Name</th>
                                            <th>Coupon Code</th>
                                            <th>Activated Date</th>
                                            <th>expiry Date</th>
                                            <th>Minimum Spend</th>
                                            <th>Discount Amount</th>
                                            <th>Coupon Limit</th>
                                            <th class="text-center">Action</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if(Array.isArray(coupon) && coupon.length> 0){ %>
                                            <% coupon.map((coup)=>{%>
                                                <tr>
                                                    <td>
                                                        <%= coup.name %>
                                                    </td>
                                                    <td>
                                                        <%= coup.code %>
                                                    </td>
                                                    <td>
                                                        <%= coup.activatedDate %>
                                                    </td>
                                                    <td>
                                                        <%= coup.expiryDate %>
                                                    </td>
                                                    <td>
                                                        <%= coup.minAmountSpend %>
                                                    </td>
                                                    <td>
                                                        <%= coup.discount %>
                                                    </td>
                                                    <td>
                                                        <%= coup.limit%>
                                                    </td>
                                                    <td class="text-center">
                                                        <button class="btn btn-sm btn-dark" id="button"
                                                            onclick="editCoupon('<%= coup._id %>','<%= coup.name%>','<%= coup.activatedDate%>','<%=coup.expiryDate%>','<%=coup.discount%>','<%=coup.limit%>','<%=coup.minAmountSpend%>')">
                                                            Edit
                                                        </button>
                                                    </td>
                                                    <td>
                                                        <a class="btn" onclick="deleteCoupon('<%= coup._id %>')">
                                                            <i class="fa-solid fa-trash fa-xl"
                                                                style="color: #000000;"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                                    <% } else{%>
                                                        <td colspan="8" class="text-center">
                                                            No coupons available.
                                                        </td>
                                                        <%}%>
                                    </tbody>
                                </table>

                            </div>
                            <!-- table-responsive //end -->
                        </div>
                        <!-- card-body end// -->
                    </div>
                </div>
                <div class="pagination-area mt-30 mb-50">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-start">
                            <li class="page-item active"><a class="page-link" href="#">01</a></li>
                            <li class="page-item"><a class="page-link" href="#">02</a></li>
                            <li class="page-item"><a class="page-link" href="#">03</a></li>
                            <li class="page-item"><a class="page-link dot" href="#">...</a></li>
                            <li class="page-item"><a class="page-link" href="#">16</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#"><i class="material-icons md-chevron_right"></i></a>
                            </li>
                        </ul>
                    </nav>
                    <div>
                    </div>
                </div>
                </div>
            </section>
    </main>
    </div>



    <!-- Create Coupon Modal -->
    <div class="modal fade" id="addCoupon" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">
                        Create coupon
                    </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/admin/createCoupon" method="post">
                        <label for="form-label">Name</label>
                        <input type="text" name="name" placeholder="Enter coupon name" class="form-control" />

                        <label for="form-label">Activation date</label>
                        <input type="date" name="activate" class="form-control" />

                        <label for="form-label">Expire date</label>
                        <input type="date" name="expiry" class="form-control" />

                        <label for="form-label">Dicount amount</label>
                        <input type="text" name="discount" placeholder="discount amount" class="form-control" />

                        <label for="form-label">Minimum amount Spend</label>
                        <input type="text" name="minAmountSpend" placeholder="min amount" class="form-control" />

                        <label for="form-label">Coupon Limit</label>
                        <input type="text" name="limit" placeholder="min amount" class="form-control" />

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Close
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Create Coupon
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit coupon Modal -->

    <div class="modal fade" id="editCoupon" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">
                        Edit coupon
                    </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <label for="form-label">Name</label>
                        <input type="text" name="name" id="nameE" value="" placeholder="Enter coupon name"
                            class="form-control" />

                        <input type="text" name="couponId" id="id" value="" hidden>

                        <label for="form-label">Activation date</label>
                        <input type="date" name="activatedDate" id="activatedDateE" placeholder="dd-mm-yyyy"
                            class="form-control" />

                        <label for="form-label">Expire date</label>
                        <input type="date" name="expiryDate" id="expiryDateE" placeholder="dd-mm-yyyy"
                            class="form-control" />


                        <label for="form-label">Dicount amount</label>
                        <input type="text" name="discount" id="discountE" class="form-control" />

                        <label for="form-label">Minimum amount Spend</label>
                        <input type="text" name="minimum" id="minimumE" class="form-control" />

                        <label for="form-label">Coupon Limit</label>
                        <input type="text" id="limitE" name="limiitt" class="form-control" />


                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Close
                            </button>
                            <button type="submit" class="btn btn-primary" onclick="Edit(event)">
                                Save changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <%- include('../layouts/admin/footer.ejs') -%>

        <script>
            function editCoupon(couponId, name, activatedDate, expiryDate, discount, limit,minimum) {
                $('#editCoupon').modal('show');

                const idInput = document.getElementById('id');
                const nameInput = document.getElementById('nameE');
                const AcitvatedInput = document.getElementById('activatedDateE');
                const expiryInput = document.getElementById('expiryDateE');
                const discountInput = document.getElementById('discountE');
                const minimumInput = document.getElementById('minimumE');
                const limitInput = document.getElementById('limitE');

                idInput.value = couponId;
                nameInput.value = name;
                AcitvatedInput.value = activatedDate;
                expiryInput.value = expiryDate;
                discountInput.value = discount;
                minimumInput.value = minimum;
                limitInput.value = limit;
            }


            function Edit(event) {
                event.preventDefault();

                const id = document.getElementById('id').value;
                const name = document.getElementById('nameE').value;
                const activated = document.getElementById('activatedDateE').value;
                const expiry = document.getElementById('expiryDateE').value;
                const discount = document.getElementById('discountE').value;
                const minimum = document.getElementById('minimumE').value;
                const limit = document.getElementById('limitE').value;

                const data =
                {
                    id: id,
                    name: name,
                    activated: activated,
                    expiry: expiry,
                    discount: discount,
                    minimum : minimum,
                    limit : limit
                }

                console.log("the datas are ", data);

                if (data) {
                    $.ajax({
                        type: 'POST',
                        url: '/admin/editCoupon',
                        data: JSON.stringify(data),
                        contentType: 'application/JSON',
                        success: function (response) {
                            Swal.fire({
                                title: 'Are you sure?',
                                text: 'Do you want to update the address?',
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes, update it!'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    if (response.updated) {
                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Updated',
                                            text: 'Address edited successfully...',
                                        });
                                        // Hide the modal
                                        $('#editCoupon').modal('hide');
                                        $('#couponReload').load('/admin/coupon #couponReload');
                                    } else {
                                        // Handle the case where response.updated is false
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error',
                                            text: 'Failed to update the address. Please try again.',
                                        });
                                    }
                                }
                            });
                        },
                        error: function (xhr, status, error) {
                            // Handle Ajax errors
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'An error occurred during the request. Please try again .',
                            });
                        }
                    });

                }
            }



            function deleteCoupon(id) {
                const data =
                {
                    id: id
                }
                fetch('/admin/deleteCoupon',
                    {
                        method: 'DELETE',
                        headers:
                        {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    })
                    .then((response) => {
                        if (response.ok) {
                            return response.json()
                        }
                        throw new Error('Delete request is failed')
                    })
                    .then(() => {
                        Swal.fire({
                            title: 'Success',
                            icon: 'success',
                            text: 'Coupon is deleted successfully'
                        })
                            .then(() => {
                                window.location.reload()
                            })
                    })
                    .catch((error) => {
                        Swal.fire('Error', 'Failed to deleting Coupon', 'error')
                        console.log(error);
                    })
            }
        </script>


        <!-- Add this to your HTML file -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

        <!-- Add this to your HTML file before your script that uses jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>